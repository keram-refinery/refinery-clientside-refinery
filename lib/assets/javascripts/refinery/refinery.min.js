(function(window, $){'use strict';(function(){function e(){return e.f.apply(e,arguments)}"undefined"===typeof Turbolinks&&(window.j={visit:function(a){document.location.href=a}});e.f=function(a,c,b){a=a.split(".");for(var d=this;a.length;)d=d[a.shift()];return new d(c,b)};e.extend=function(a,c){for(var b in c)c.hasOwnProperty(b)&&!a.hasOwnProperty(b)&&(a[b]=c[b]);return a};e.flash=function(a,c){var b=$("#flash-wrapper").empty(),b=$("<div/>",{"class":"flash flash-"+a,html:c}).appendTo(b);0===b.find(".flash-close").length&&
$("<a/>",{"class":"flash-close",text:"close",href:"#"}).appendTo(b)};e.validator={email:RegExp(/^([a-z0-9_\.\-]+)@([\da-z\.\-]+)\.([a-z\.]{2,6})$/i),url:RegExp(/^(https?|ftp):\/\/([\da-z\.\-]+)\.([a-z\.]{2,6})([\/\w \.\-]*)*\/?$/i),page:RegExp("^(https?://"+document.location.host+"|/[a-z0-9]+)")};e.provide=function(a,c,b){a=a.split(".");var d=a.shift();for(b=b||window;d;)a.length||"undefined"===c?b=b[d]?b[d]:b[d]={}:b[d]=c,d=a.shift()};e.pubsub=function(){var a=$({});return{unbind:function(){a.unbind()},
subscribe:function(c,b){a.on(c,b)},unsubscribe:function(c,b){a.off(c,b)},publish:function(c,b){a.trigger(c,b)}}}();e.xhr={processHtml:function(a,c,b){for(var d=a.length-1;0<=d;d--)if("string"===typeof a[d]&&0<c.length)b?c.replaceWith(a[d]):c.html(a[d]);else for(var f in a[d])a[d].hasOwnProperty(f)&&e.i(f,a[d][f])},processMessage:function(a){var c=$("#flash-wrapper").empty(),b;if("object"===typeof a)for(b in a)a.hasOwnProperty(b)&&c.append(a[b]);else c.append(a)},error:function(a,c){var b='<b class="'+
c+'">'+a.statusText+"</b>",d;try{d=a.g?a.g:JSON.parse(a.responseText),"string"===typeof d.error&&(b+="! "+d.error)}catch(f){}e.flash("error",b)},success:function(a,c,b,d,f){c=b.getResponseHeader("X-XHR-Redirected-To");a.html&&e.xhr.processHtml(a.html,d,f);a.message&&e.xhr.processMessage(a.message);c&&window.history.pushState({refinery:!0,url:c,prev_url:document.location.href},"",c)}};e.i=function(a,c){$("#"+a).html(c)};e.spinner={on:function(){$("body").addClass("loading").prop("aria-busy",!0)},off:function(){$("body").removeClass("loading").prop("aria-busy",
!1)}};e.log="object"===typeof console&&"function"===typeof console.log?console.log:function(){};e.htmlEncode=function(){function a(a){return c[a]}var c={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return function(b){return b.replace(/[&<>\"\']/g,a)}}();e.ui={};e.provide("refinery",e)})();(function(e){e.ObjectState=function(a){a=a||{};this.states=$.extend(a,this.states)};e.ObjectState.prototype={states:{},_initialisable:function(){return!(this.get("initialising")||this.get("initialised"))},set:function(a,c){var b;if("object"===typeof a)for(b in a)a.hasOwnProperty(b)&&(this.states[b]=!!a[b]);else this.states[a]="undefined"===typeof c?!0:!!c},get:function(a){return!!this.states[a]},is:function(a){return!!(this.states[a]||this["_"+a]&&this["_"+a]())}}})(refinery);(function(e){e.Object=function(a,c){this.id=e.Object.guid++;this.options=$.extend({},this.options,a);this.events={};this.uid=this.name+this.id;c||(this.state=new this.State)};e.Object.prototype={id:0,name:"Object",version:"0.1",module:"refinery",options:null,events:null,holder:null,fullname:"refinery.Object",State:e.ObjectState,state:null,is:function(a,c){if(this.state){if("undefined"===typeof c&&"object"!==typeof a)return this.state.is(a);this.state.set(a,c)}},on:function(a,c){var b=this.events;
b[a]=b[a]||[];b[a].push(c);return this},off:function(a,c){var b=this.events[a];b&&b.splice(b.indexOf(c),1);return this},subscribe:function(a,c){e.pubsub.subscribe(this.uid+"."+a,c);return this},unsubscribe:function(a,c){e.pubsub.unsubscribe(this.uid+"."+a,c);return this},trigger:function(a,c){var b=this.events[a],d;c="undefined"===typeof c||c instanceof Array?c:[c];if(b)for(d=b.length-1;0<=d&&!1!==b[d].apply(this,c);d--);e.pubsub.publish(this.uid+"."+a,c);return this},destroy:function(){this.holder&&
this.holder.unbind();this.state=null;this.trigger("destroy");this.events={};return this},_destroy:function(){return e.Object.prototype.destroy.apply(this,arguments)},init:function(a){this.is("initialisable")&&(this.holder=a,this.is("initialised",!0),this.trigger("init"));return this}};e.Object.guid=1;e.Object.create=function(a){var c,b,d,f=["objectPrototype","objectConstructor","objectMethods","id","uid"];a=a||{};d=a.objectMethods;c=a.objectConstructor||function(a,b){e.Object.call(this,a,b)};c.prototype=
a.objectPrototype||new e.Object(null,!0);a.module=a.module?"refinery."+a.module:c.prototype.module;a.fullname=a.module+"."+a.name;e.provide(a.fullname,c);for(b in a)a.hasOwnProperty(b)&&-1===f.indexOf(b)&&(c.prototype[b]=a[b]);if(d)for(b in d)d.hasOwnProperty(b)&&(c[b]=d[b]);return c}})(refinery);(function(e){e.Object.create({name:"UserInterface",options:{ui_modules:e.ui,main_content_selector:"#content"},addObject:function(a){this.a.push(a);return this},bind_events:function(){var a=this,c=a.holder;c.on("click",".flash-close",function(a){a.preventDefault();$(this).parent().fadeOut();return!1});c.on("ajax:success",function(b,d,f,g){var k=g.getResponseHeader("X-XHR-Redirected-To"),h=!0;b=b.target;d.redirect_to?Turbolinks.visit(d.redirect_to):(k||"a"===b.tagName.toLowerCase()?(b=c.find(a.options.main_content_selector),
h=!1):b=$(b),a.destroy(),e.xhr.success(d,f,g,b,h),a.trigger("ui:change"))});c.on("ajax:error",function(a,c,f){e.xhr.error(c,f)});c.on("click",".tree .toggle",function(b){b.preventDefault();a.h($(this).parents("li:first"))})},h:function(a){var c=a.find(".toggle").first(),b=a.find(".nested").first();c.hasClass("expanded")?(c.removeClass("expanded"),b.slideUp()):b.hasClass("data-loaded")?(c.addClass("expanded"),b.slideDown()):(a.addClass("loading"),b.load(b.data("ajax-content"),function(){c.addClass("expanded");
b.slideDown();a.removeClass("loading");b.hasClass("data-cache")&&b.addClass("data-loaded")}))},initialize_modules:function(){var a=this.holder,c=this.options.ui_modules,b;for(b in c)if(c.hasOwnProperty(b))c[b](a,this)},c:function(){this.holder.find(".ui-tabs").each(function(){var a=$(this),c=a.find(".ui-tabs-nav li"),b=$.cookie("tab_"+a.attr("id")),d=a.find(".ui-tabs-nav .ui-state-active").index();b&&$(c.get(b)).is(":visible")?d=b:-1===d&&(d=a.find(".ui-tabs-nav li:visible").first().index());a.tabs({active:d,
activate:function(b,c){$.cookie("tab_"+a.attr("id"),c.newTab.index(),{path:"/"});c.newPanel.find("input.text, textarea").first().focus()}})})},d:function(){var a=this.holder;$.each(["selectable","sortable","accordion"],function(c,b){a.find(".ui-"+b).each(function(){var a=$(this);a[b](a.data("ui-"+b+"-options"))})});this.c()},b:function(){this.holder.find("div.checkboxes").each(function(){var a=$(this),c=a.find("input:checkbox").not("[readonly]");1<c.length&&a.find(".checkboxes-cmd."+(c.length===c.filter(":checked").length?
"none":"all")).removeClass("hide")});this.holder.on("click",".checkboxes-cmd",function(a){a.preventDefault();a=$(this);var c=a.parent();c.find("input:checkbox").prop("checked",a.hasClass("all"));c.find(".checkboxes-cmd").toggleClass("hide")})},e:function(){this.holder.on("click",".toggle-hide",function(){var a=$(this);$(a.attr("href")).toggleClass("js-hide");a.toggleClass("toggle-on")})},destroy:function(){if(this.is("initialised"))try{for(var a=this.a.length-1;0<=a;a--)this.a[a].destroy()}catch(c){e.log(a,
c,this.a)}return this._destroy()},init:function(a){this.is("initialisable")&&(this.is("initialising",!0),this.holder=a,this.a=[],this.bind_events(),this.d(),this.b(),this.e(),this.initialize_modules(),this.is({initialised:!0,initialising:!1}),this.trigger("init"));return this}})})(refinery);}(window, jQuery));
