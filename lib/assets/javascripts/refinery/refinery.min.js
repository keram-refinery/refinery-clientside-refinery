(function(window, $){'use strict';(function(){function d(){return d.f.apply(d,arguments)}"undefined"===typeof Turbolinks&&(window.Turbolinks={visit:function(a){document.location.href=a}});d.f=function(a,b,c){a=a.split(".");for(var e=this;a.length;)e=e[a.shift()];return new e(b,c)};d.extend=function(a,b){for(var c in b)b.hasOwnProperty(c)&&!a.hasOwnProperty(c)&&(a[c]=b[c]);return a};d.flash=function(a,b){var c=$("#flash-wrapper").empty(),c=$("<div/>",{"class":"flash flash-"+a,html:b}).appendTo(c);0===c.find(".flash-close").length&&
$("<a/>",{"class":"flash-close",text:"close",href:"#"}).appendTo(c)};d.validator={email:RegExp(/^([a-z0-9_\.\-]+)@([\da-z\.\-]+)\.([a-z\.]{2,6})$/i),url:RegExp(/^(https?|ftp):\/\/([\da-z\.\-]+)\.([a-z\.]{2,6})([\/\w \.\-]*)*\/?$/i),page:RegExp("^(https?://"+document.location.host+"|/[a-z0-9]+)")};d.provide=function(a,b,c){a=a.split(".");var e=a.shift();for(c=c||window;e;)a.length||"undefined"===b?c=c[e]?c[e]:c[e]={}:c[e]=b,e=a.shift()};d.pubsub=function(){var a=$({});return{unbind:function(){a.unbind()},
subscribe:function(b,c){a.on(b,c)},unsubscribe:function(b,c){a.off(b,c)},publish:function(b,c){a.trigger(b,c)}}}();d.xhr={processHtml:function(a,b,c){for(var e=a.length-1;0<=e;e--)if("string"===typeof a[e])c?b.replaceWith(a[e]):b.html(a[e]);else for(var f in a[e])a[e].hasOwnProperty(f)&&d.i(f,a[e][f])},processMessage:function(a){var b=$("#flash-wrapper").empty(),c;if("object"===typeof a)for(c in a)a.hasOwnProperty(c)&&b.append(a[c]);else b.append(a)},error:function(a,b){var c='<b class="'+b+'">'+
a.statusText+"</b>",e;try{e=a.g?a.g:JSON.parse(a.responseText),"string"===typeof e.error&&(c+="! "+e.error)}catch(f){}d.flash("error",c)},success:function(a,b,c,e){a.html&&d.xhr.processHtml(a.html,b,e);a.message&&d.xhr.processMessage(a.message);c&&window.history.pushState({refinery:!0,url:c,prev_url:document.location.href},"",c)}};d.i=function(a,b){$("#"+a).html(b)};d.spinner={on:function(){$("body").addClass("loading").prop("aria-busy",!0)},off:function(){$("body").removeClass("loading").prop("aria-busy",
!1)}};d.log="object"===typeof console&&"function"===typeof console.log?console.log:function(){};d.htmlEncode=function(){function a(a){return b[a]}var b={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return function(b){return b.replace(/[&<>\"\']/g,a)}}();d.ui={};d.provide("refinery",d)})();(function(d){d.ObjectState=function(a){a=a||{};this.states=$.extend(a,this.states)};d.ObjectState.prototype={states:{},_initialisable:function(){return!(this.get("initialising")||this.get("initialised"))},set:function(a,b){var c;if("object"===typeof a)for(c in a)a.hasOwnProperty(c)&&(this.states[c]=!!a[c]);else this.states[a]="undefined"===typeof b?!0:!!b},get:function(a){return!!this.states[a]},is:function(a){return!!(this.states[a]||this["_"+a]&&this["_"+a]())}}})(refinery);(function(d){d.Object=function(a,b){this.id=d.Object.guid++;this.options=$.extend({},this.options,a);this.events={};this.uid=this.name+this.id;b||(this.state=new this.State)};d.Object.prototype={id:0,name:"Object",version:"0.1",module:"refinery",options:null,events:null,holder:null,fullname:"refinery.Object",State:d.ObjectState,state:null,is:function(a,b){if(this.state){if("undefined"===typeof b&&"object"!==typeof a)return this.state.is(a);this.state.set(a,b)}},on:function(a,b){var c=this.events;
c[a]=c[a]||[];c[a].push(b);return this},off:function(a,b){var c=this.events[a];c&&c.splice(c.indexOf(b),1);return this},subscribe:function(a,b){d.pubsub.subscribe(this.uid+"."+a,b);return this},unsubscribe:function(a,b){d.pubsub.unsubscribe(this.uid+"."+a,b);return this},trigger:function(a,b){var c=this.events[a],e;b="undefined"===typeof b||b instanceof Array?b:[b];if(c)for(e=c.length-1;0<=e&&!1!==c[e].apply(this,b);e--);d.pubsub.publish(this.uid+"."+a,b);return this},destroy:function(){this.holder&&
this.holder.unbind();this.state=null;this.trigger("destroy");this.events={};return this},_destroy:function(){return d.Object.prototype.destroy.apply(this,arguments)},init:function(a){this.is("initialisable")&&(this.holder=a,this.is("initialised",!0),this.trigger("init"));return this}};d.Object.guid=1;d.Object.create=function(a){var b,c,e,f=["objectPrototype","objectConstructor","objectMethods","id","uid"];a=a||{};e=a.objectMethods;b=a.objectConstructor||function(a,b){d.Object.call(this,a,b)};b.prototype=
a.objectPrototype||new d.Object(null,!0);a.module=a.module?"refinery."+a.module:b.prototype.module;a.fullname=a.module+"."+a.name;d.provide(a.fullname,b);for(c in a)a.hasOwnProperty(c)&&-1===f.indexOf(c)&&(b.prototype[c]=a[c]);if(e)for(c in e)e.hasOwnProperty(c)&&(b[c]=e[c]);return b}})(refinery);(function(d){d.Object.create({name:"UserInterface",options:{ui_modules:d.ui,main_content_selector:"#content"},addObject:function(a){this.a.push(a);return this},bind_events:function(){var a=this,b=a.holder,c=b.find(a.options.main_content_selector);b.on("click",".flash-close",function(a){a.preventDefault();$(this).parent().fadeOut();return!1});b.on("ajax:success",function(b,f,h,g){f.redirect_to?Turbolinks.visit(f.redirect_to):(a.destroy(),d.xhr.success(f,c,g.getResponseHeader("X-XHR-Redirected-To")),
a.trigger("ui:change"))});b.on("ajax:error",function(a,b,c){d.xhr.error(b,c)});b.on("click",".tree .toggle",function(b){b.preventDefault();a.h($(this).parents("li:first"))})},h:function(a){var b=a.find(".toggle").first(),c=a.find(".nested").first();b.hasClass("expanded")?(b.removeClass("expanded"),c.slideUp()):c.hasClass("data-loaded")?(b.addClass("expanded"),c.slideDown()):(a.addClass("loading"),c.load(c.data("ajax-content"),function(){b.addClass("expanded");c.slideDown();a.removeClass("loading");
c.hasClass("data-cache")&&c.addClass("data-loaded")}))},initialize_modules:function(){var a=this.holder,b=this.options.ui_modules,c;for(c in b)if(b.hasOwnProperty(c))b[c](a,this)},c:function(){this.holder.find(".ui-tabs").each(function(){var a=$(this),b=a.find("> ul"),c=b.find("li"),d=$.cookie("tab_"+a.attr("id")),f=b.find(".ui-state-active").index();d&&$(c.get(d)).is(":visible")?f=d:-1===f&&(f=b.find("li:visible").first().index());a.tabs({active:f,activate:function(b,c){$.cookie("tab_"+a.attr("id"),
c.newTab.index()-1,{path:"/"});c.newPanel.find("input.text, textarea").first().focus()}})})},d:function(){var a=this.holder;$.each(["selectable","sortable","accordion"],function(b,c){a.find(".ui-"+c).each(function(){var a=$(this);a[c](a.data("ui-"+c+"-options"))})});this.c()},b:function(){this.holder.find("div.checkboxes").each(function(){var a=$(this),b=a.find("input:checkbox").not("[readonly]");1<b.length&&a.find(".checkboxes-cmd."+(b.length===b.filter(":checked").length?"none":"all")).removeClass("hide")});
this.holder.on("click",".checkboxes-cmd",function(a){a.preventDefault();a=$(this);var b=a.parent();b.find("input:checkbox").not("[readonly]").prop("checked",a.hasClass("all"));b.find(".checkboxes-cmd").toggleClass("hide")})},e:function(){this.holder.on("click",".toggle-hide",function(){var a=$(this);$(a.attr("href")).toggleClass("js-hide");a.toggleClass("toggle-on")})},destroy:function(){if(this.is("initialised"))try{for(var a=this.a.length-1;0<=a;a--)this.a[a].destroy()}catch(b){d.log(a,b,this.a)}return this._destroy()},
init:function(a){this.is("initialisable")&&(this.is("initialising",!0),this.holder=a,this.a=[],this.bind_events(),this.d(),this.b(),this.e(),this.initialize_modules(),this.is({initialised:!0,initialising:!1}),this.trigger("init"));return this}})})(refinery);}(window, jQuery));
