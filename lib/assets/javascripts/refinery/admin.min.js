(function(window, $){'use strict';(function(b){b.admin={ui:{},backend_path:function(){var a=document.location.pathname.split("/").filter(function(a){return""!==a});return/^[a-z]{2}(-[a-zA-Z]{2,3})?$/.test(a[0])?"/"+a[0]+"/"+a[1]:"/"+a[0]}}})(refinery);(function(b){b.Object.create({name:"Form",module:"admin",k:function(a){var d=this,c,b,f,g;c={text:t("refinery.admin.form_unsaved_save_and_continue"),"class":"submit-button",click:function(){var c=d.holder,b=a.attr("class").match(/flag-([a-z]{2}(?:-[a-zA-Z]{2,3})?)?$/)[1];$("<input/>",{type:"hidden",name:"switch_frontend_locale",value:b}).appendTo(c);c.trigger("before-submit");c.submit()}};b={text:t("refinery.admin.form_unsaved_continue"),click:function(){Turbolinks.visit(a.attr("href"))}};f={text:t("refinery.admin.form_unsaved_cancel"),
click:function(){g.dialog("close")}};g=$("<div/>",{html:t("refinery.admin.form_unsaved_html")}).dialog({resizable:!1,height:140,modal:!0,title:t("refinery.admin.form_unsaved_title"),buttons:[c,b,f]});d.on("destroy",function(){g.dialog("destroy")})},g:function(){var a=this,d=a.holder;d.on("click",".locale-picker a",function(c){a.b!==d.serialize()&&(c.preventDefault(),c.stopPropagation(),a.k($(this)))})},i:function(){var a=this.holder,d=$("meta[name=csrf-param]").attr("content"),c=a.find('input[type="file"]');
if(0<c.length)a.on("submit",function(e){e.preventDefault();e.stopPropagation();b.spinner.on();0===a.find('input[name="'+d+'"]').length&&$("<input/>",{name:d,type:"hidden",value:$("meta[name=csrf-token]").attr("content")}).appendTo(a);a.trigger("before-submit");$.ajax(this.action,{data:a.serializeArray(),files:c,iframe:!0,processData:!1}).done(function(d,c,b){a.trigger("ajax:success",[d,c,b])}).always(function(){b.spinner.off()})})},h:function(){function a(a){a.stopPropagation()}function d(){if(c.is(":valid")){c.removeData("remote");
c.removeAttr("data-remote");if(!l||l.closed)l=window.open("",k.attr("href"));c.attr({action:k.attr("href"),method:"POST",target:k.attr("href")});c.trigger("before-submit");c.on("submit",a);c.submit();c.off("submit",a);c.attr({action:b,method:g,target:f});h&&(c.attr("data-remote",h),c.data("remote",h))}else alert("Preview is not possible because form is not filled properly!")}var c=this.holder,b=c.attr("action"),f=c.attr("target"),g=c.attr("method"),h=c.data("remote"),k=c.find(".preview-button"),l;
0<k.length&&(c.on("click",".preview-button",function(a){a.preventDefault();a.stopPropagation();d()}),c.on("change","input, select, textarea",function(){l&&!l.closed&&d()}))},f:function(){var a=this,d=a.holder,c=d.find(".form-actions .submit-button"),b;0<c.length&&(b=c.val(),d.on("change","input, select, textarea",function(){a.b!==d.serialize()&&"!"!==b[b.length]?c.val(b+" !"):c.val(b.replace(/ !$/,""))}));d.find("input.autocomplete").each(function(){var a=$(this),d,c=a.data("autocomplete");c.multiple&&
(d=c.source,a.bind("keydown",function(a){a.which===$.ui.keyCode.TAB&&$(this).data("ui-autocomplete").menu.active&&a.preventDefault()}),$.extend(c,{select:function(a,d){var c=this.value.split(/,\s*/);c.pop();c.push(d.item.value);c.push("");this.value=c.join(", ");return!1},source:function(a,c){var b=a.term.split(/,\s*/),e=b.pop(),f=d.filter(function(a){return-1===b.indexOf(a)});c($.ui.autocomplete.filter(f,e))},focus:function(){return!1}}));a.autocomplete(c)})},e:function(){function a(){var a=d.scrollTop()+
d.height(),g=c.position().top;a<g?b.addClass("fly"):b.removeClass("fly")}var d=$(window),c=this.holder.find(".form-actions"),b=this.holder.find(".form-actions-left");0<this.holder.find("textarea").length&&0<c.length&&0<b.length&&(d.on("scroll",a),this.on("destroy",function(){d.unbind("scroll",a)}),a())},init:function(a){this.is("initialisable")&&(this.is("initialising",!0),this.holder=a,this.g(),this.f(),this.i(),this.h(),this.b=a.serialize(),this.e(),this.is({initialised:!0,initialising:!1}),this.trigger("init"));
return this}});b.admin.ui.form=function(a,d){a.find("form").each(function(){d.addObject(b("admin.Form").init($(this)))})}})(refinery);(function(b){b.Object.create({name:"FormPageParts",module:"admin",c:function(a){for(var d,c='<ul class="records">',b=0,f=a.length;b<f;b++)d=a[b],c+='<li data-part="'+d.name+'" class="clearfix" ><label class="stripped"><input type="checkbox"'+(d.active?' checked="1"':"")+"> "+d.title+'</label> <span class="actions"><span class="icon-small move-icon">'+t("refinery.admin.button_move")+"</span></span></li>";return c+"</ul>"},d:function(){function a(){var a=[],g;f.find("li").each(function(d){var b=$(this),
e=b.data("part"),b=b.find("input").is(":checked"),f=c.find('li a[href="#page_part_'+e+'"]').parent().detach(),e=$("#page_part_"+e);b?(f.removeClass("js-hide"),e.removeClass("js-hide")):(f.removeClass("ui-tabs-active ui-state-active"),f.addClass("js-hide"),e.addClass("js-hide"));e.find("input.part-active").prop("checked",b);e.find("input.part-position").val(d+"");f.length&&(a[a.length]=f)});for(g=a.length;0<=g;g--)c.prepend(a[g]);0===c.find(".ui-tabs-active").length&&d.tabs({active:b.index(c.find("li:visible").first())})}
var d=this.holder,c=d.find(".ui-tabs-nav"),b=c.find("li"),f=$("<div/>"),g;f.html(this.c(d.find("#page_parts-options").data("page-parts")));g=[{text:t("refinery.admin.button_done"),"class":"submit-button",click:function(){a();f.dialog("close")}}];f.dialog({title:t("refinery.admin.form_page_parts_manage"),modal:!0,resizable:!0,autoOpen:!1,width:400,buttons:g});d.on("click","#page_parts-options",function(a){a.preventDefault();f.dialog("open")});this.on("destroy",function(){f.dialog("destroy");f.off()})},
init:function(a){this.is("initialisable")&&(this.is("initialising",!0),this.holder=a,this.d(),this.is({initialised:!0,initialising:!1}),this.trigger("init"));return this}});b.admin.ui.formPageParts=function(a,d){a.find("#page_parts").each(function(){d.addObject(b("admin.FormPageParts").init($(this)))})}})(refinery);(function(b){b.Object.create({objectConstructor:function(a,d){var c=this;b.Object.apply(c,arguments);d||(c.options.nested_sortable.stop=function(a,d){c.update(d.item)})},name:"SortableList",module:"admin",options:{nested_sortable:{m:"ul",items:"li",n:1}},set:null,html:null,a:function(a){return a.attr("id")&&/([0-9]+)$/.test(a.attr("id"))?a.attr("id").match(/([0-9]+)$/)[1]:null},update:function(a){var d=this,c=d.holder,e=c.data("update_positions_url"),f=c.nestedSortable("toArray");a={item:{id:d.a(a),
prev_id:d.a(a.prev()),next_id:d.a(a.next()),parent_id:d.a(a.parent().parent())}};d.is("updating")||JSON.stringify(f)===JSON.stringify(d.set)||(d.is({updating:!0,updated:!1}),c.nestedSortable("disable"),b.spinner.on(),$.post(e,a,null,"JSON").done(function(a,e,k){"error"===e?c.html(d.html):(d.set=f,d.html=c.html());b.xhr.success(a,c,k.getResponseHeader("X-XHR-Redirected-To"));d.is("updated",!0);d.trigger("update")}).fail(function(a){c.html(d.html);b.xhr.error(a)}).always(function(){b.spinner.off();
d.is("updating",!1);c.nestedSortable("enable")}));return d},destroy:function(){this.holder.nestedSortable("destroy");this.set=null;return this._destroy()},init:function(a){this.is("initialisable")&&(this.is("initialising",!0),a.nestedSortable(this.options.nested_sortable),this.holder=a,this.set=a.nestedSortable("toArray"),this.html=a.html(),this.is({initialised:!0,initialising:!1}),this.trigger("init"));return this}});b.admin.ui.sortableList=function(a,d){a.find(".sortable-list").each(function(){d.addObject(b("admin.SortableList").init($(this)))})}})(refinery);(function(b){b.Object.create({objectConstructor:function(a,d){var c=this;b.Object.apply(c,arguments);d||(c.options.nested_sortable.stop=function(a,d){c.update(d.item)})},objectPrototype:b("admin.SortableList",{nested_sortable:{listType:"ul",handle:".move",items:"li",isAllowed:function(a,d,c){return d&&d.text()===c.parent().text()?!1:!0},maxLevels:0}},!0),name:"SortableTree"});b.admin.ui.sortableTree=function(a,d){a.find(".sortable-tree").each(function(){d.addObject(b("admin.SortableTree").init($(this)))})}})(refinery);refinery.Object.create({objectPrototype:refinery("UserInterface",{ui_modules:refinery.admin.ui},!0),module:"admin",name:"UserInterface"});(function(b){function a(a){a=$.extend(a||{},{closed:!0});b.ObjectState.call(this,a)}a.prototype={_openable:function(){return this.get("initialised")&&this.get("closed")&&!this.get("opening")},_closable:function(){return!this.get("closing")&&this.get("opened")},_loadable:function(){return!this.get("loading")&&!this.get("loaded")},_insertable:function(){return this.get("initialised")&&!this.get("inserting")}};b.extend(a.prototype,b.ObjectState.prototype);b.Object.create({name:"Dialog",module:"admin",
options:{title:"",url_path:null,width:710,modal:!0,autoOpen:!1,autoResize:!0},State:a,close:function(){this.is("closable")&&this.holder.dialog("close");return this},open:function(){this.is("openable")&&(this.is("opening",!0),this.holder.dialog("open"));return this},insert:function(a){var c=a.closest(".ui-tabs-panel"),b;0<c.length&&(c=c.attr("id").replace(/-/g,"_"),"function"===typeof this[c]?b=this[c](a):a.hasClass("ui-selected")&&(b=this.j(a)));b&&this.trigger("insert",b);return this},init_buttons:function(){var a=
this,c=a.holder;c.on("click",".cancel-button, .close-button",function(c){c.preventDefault();a.close();return!1});c.on("submit","form",function(c){var b=$(this);b.attr("action")||(c.preventDefault(),c.stopPropagation(),a.insert(b))})},load:function(){var a=this,c=a.holder,e=b.admin.backend_path()+a.options.url_path,f=$("#frontend_locale");a.is("loadable")&&(a.is("loading",!0),f={id:a.id,frontend_locale:0<f.length?f.val():"en"},e=$.ajax(e,f),e.fail(function(){c.html($("<div/>",{"class":"flash error",
html:t("refinery.admin.dialog_content_load_fail")}))}),e.done(function(e){var f=$("<div/>");c.empty();f.appendTo(c);b.xhr.success(e,f);a.l(f);a.is("loaded",!0)}),e.always(function(){a.is("loading",!1);c.removeClass("loading");a.trigger("load")}));return this},l:function(a){var c=this,e;(function g(){e=b("admin.UserInterface",{main_content_selector:".dialog-content-wrapper"}).init(a);e.subscribe("ui:change",function(){e.destroy();g()});c.on("destroy",function(){e.destroy()})})()},bind_events:function(){var a=
this,c=a.holder;a.on("insert",a.close);a.on("open",a.load);c.on("dialogopen",function(){a.is({opening:!1,opened:!0,closed:!1});a.trigger("open")});c.on("dialogbeforeclose",function(){a.is({closing:!1,closed:!0,opened:!1});a.trigger("close")});c.on("selectableselected",".records.ui-selectable",function(c,b){a.insert($(b.selected))});c.on("click",".pagination a",function(a){var d=$(this).attr("href");a.preventDefault();a.stopPropagation();$.get(d).done(function(a,d,b){c.find(".dialog-content-wrapper").trigger("ajax:success",
[a,d,b])}).always(function(){b.spinner.off()})});c.on("ajax:success",function(c,b){a.upload_area(b)})},upload_area:function(){},j:function(a){a.removeClass("ui-selected");return a.data("dialog")},destroy:function(){this.is("initialised")&&this.holder.parent().hasClass("ui-dialog")&&this.holder.dialog("destroy");return this._destroy()},init:function(){var a;this.is("initialisable")&&(this.is("initialising",!0),a=$("<div/>",{id:"dialog-"+this.id,"class":"loading"}),a.dialog(this.options),this.holder=
a,this.bind_events(),this.init_buttons(),this.is({initialised:!0,initialising:!1}),this.trigger("init"));return this}})})(refinery);(function(b){b.Object.create({name:"Picker",module:"admin",elm_current_record_id:null,elm_record_holder:null,elm_no_picked_record:null,elm_remove_picked_record:null,dialog:null,open:function(){this.dialog.init().open();return this},close:function(){this.dialog.close();return this},insert:function(a){return a},destroy:function(){this.dialog.destroy();return this._destroy()},bind_events:function(){var a=this,b=a.holder;b.find(".current-record-link").on("click",function(c){c.preventDefault();a.open()});
b.find(".remove-picked-record").on("click",function(c){c.preventDefault();a.elm_current_record_id.val("");a.elm_record_holder.empty();a.elm_remove_picked_record.addClass("hide");a.elm_no_picked_record.removeClass("hide");a.trigger("remove")})},bind_dialog:function(a){return a},init:function(a,b){this.is("initialisable")&&(this.is("initialising",!0),this.holder=a,this.dialog=this.bind_dialog(b),this.elm_current_record_id=a.find(".current-record-id"),this.elm_record_holder=a.find(".record-holder"),
this.elm_no_picked_record=a.find(".no-picked-record-selected"),this.elm_remove_picked_record=a.find(".remove-picked-record"),this.bind_events(),this.is({initialised:!0,initialising:!1}),this.trigger("init"));return this}})})(refinery);(function(b){b.Object.create({objectConstructor:function(a){a.url_path="/dialogs/image/"+a.image_id;b.Object.apply(this,arguments)},objectPrototype:b("admin.Dialog",{title:t("refinery.admin.image_dialog_title")},!0),name:"ImageDialog",insert:function(a){var b=a.find("#image-size .ui-selected a");return this.trigger("insert",{id:a.find("#image-id").val(),alt:a.find("#image-alt").val(),size:b.data("size"),geometry:b.data("geometry"),sizes:a.find("#image-preview").data()})}})})(refinery);(function(b){b.Object.create({objectPrototype:b("admin.Dialog",{title:t("refinery.admin.images_dialog_title"),url_path:"/dialogs/images"},!0),name:"ImagesDialog",external_image_area:function(a){var b=a.find('input[type="url"]:valid');a=a.find('input[type="text"]:valid');var c=b.val(),e=a.val();if(c)return b.val(""),a.val(""),{url:c,alt:e}},upload_area:function(a){a.image&&(this.trigger("insert",a.image),this.holder.find("li.ui-selected").removeClass("ui-selected"),this.holder.find(".ui-tabs").tabs({active:0}))}})})(refinery);(function(b){b.Object.create({objectPrototype:b("admin.Dialog",{title:t("refinery.admin.links_dialog_title"),url_path:"/dialogs/links"},!0),name:"LinksDialog",email_link_area:function(a){var b=a.find("#email_address_text:valid"),c=a.find("#email_default_subject_text");a=a.find("#email_default_body_text");var e=b.val(),f=c.val(),g=a.val(),h="";if(e)return h="mailto:"+encodeURIComponent(e)+"?subject="+encodeURIComponent(f)+"&body="+encodeURIComponent(g),b.val(""),c.val(""),a.val(""),{type:"email",title:e,
url:h}},website_link_area:function(a){var b=a.find("#web_address_text:valid");a=a.find("#web_address_target_blank");var c=b.val(),e=a.prop("checked");if(c)return b.val("http://"),a.prop("checked",!1),{type:"website",title:c.replace(/^https?:\/\//,""),url:c,blank:e}}})})(refinery);(function(b){b.Object.create({objectPrototype:b("admin.Dialog",{title:t("refinery.admin.resources_dialog_title"),url_path:"/dialogs/resources"},!0),name:"ResourcesDialog",upload_area:function(a){a.file&&(this.trigger("insert",a.file),this.holder.find("li.ui-selected").removeClass("ui-selected"),this.holder.find(".ui-tabs").tabs({active:0}))}})})(refinery);(function(b){b.Object.create({objectPrototype:b("admin.Picker",null,!0),name:"ImagePicker",bind_dialog:function(a){var b=this;a.on("load",function(){a.holder.find('li[aria-controls="external-image-area"]').hide()}).on("insert",function(c){b.insert(c);a.close()});return a},insert:function(a){this.elm_current_record_id.val(a.id);this.elm_record_holder.html($("<img/>",{"class":"record size-medium",src:a.thumbnail}));this.elm_no_picked_record.addClass("hide");this.elm_remove_picked_record.removeClass("hide");
this.trigger("insert");return this}});b.admin.ui.imagePicker=function(a,d){a.find(".image-picker").each(function(){d.addObject(b("admin.ImagePicker").init($(this),b("admin.ImagesDialog")))})}})(refinery);(function(b){b.Object.create({objectPrototype:b("admin.Picker",null,!0),name:"ResourcePicker",bind_dialog:function(a){var b=this;a.on("insert",function(c){b.insert(c);a.close()});return a},insert:function(a){var b=$("<span/>",{text:a.name+" - "+a.size,"class":"title"+(" "+a.ext||"")});this.elm_current_record_id.val(a.id);this.elm_record_holder.html($("<a/>",{src:a.url,html:b,"class":"record"}));this.elm_no_picked_record.addClass("hide");this.elm_remove_picked_record.removeClass("hide");this.trigger("insert");
return this}});b.admin.ui.resourcePicker=function(a,d){a.find(".resource-picker").each(function(){d.addObject(b("admin.ResourcePicker").init($(this),b("admin.ResourcesDialog")))})}})(refinery);}(window, jQuery));
